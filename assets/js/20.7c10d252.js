(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{421:function(t,e,a){"use strict";a.r(e);var l=a(48),s=Object(l.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[t._v("#")]),t._v(" 介绍")]),t._v(" "),a("p",[t._v("CORS：Cross-Origin Resource Sharing（跨源资源共享/跨域资源共享），是一种允许当前域的资源被其他域的脚本请求访问的机制，通常由于同域安全策略浏览器会禁止这种跨域请求。")]),t._v(" "),a("p",[t._v("CORS 和代理转发应该是目前使用最多的解决跨域的方案。")]),t._v(" "),a("h2",{attrs:{id:"cors请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cors请求"}},[t._v("#")]),t._v(" CORS请求")]),t._v(" "),a("p",[t._v("CORS 请求可以分为 简单请求 和 非简单请求。")]),t._v(" "),a("h3",{attrs:{id:"简单请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简单请求"}},[t._v("#")]),t._v(" 简单请求")]),t._v(" "),a("p",[t._v("浏览器发现是简单请求，就会自动在头信息之中，添加一个"),a("code",[t._v("origin")]),t._v("字段。服务端收到请求后会检测 "),a("code",[t._v("origin")]),t._v(" 是否符合要求，如果符合，则返回"),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("，否则抛出错误。")]),t._v(" "),a("p",[t._v("请求报文")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token request-line"}},[a("span",{pre:!0,attrs:{class:"token property"}},[t._v("GET")]),t._v(" /resources/public-data/ HTTP/1.1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Host:")]),t._v(" bar.other\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Origin:")]),t._v(" http://foo.example\n...\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("响应报文")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token response-status"}},[t._v("HTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v("200 OK")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Server:")]),t._v(" Apache/2.0.61\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Origin:")]),t._v(" http://foo.example\n...\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[a("strong",[t._v("符合以下所有要求的请求被称为简单请求：")])]),t._v(" "),a("ul",[a("li",[t._v("使用下列方法之一：\n"),a("ul",[a("li",[t._v("GET")]),t._v(" "),a("li",[t._v("HEAD")]),t._v(" "),a("li",[t._v("POST")])])]),t._v(" "),a("li",[t._v("除了被用户代理自动设置的首部字段（例如 Connection ，User-Agent）和在 Fetch 规范中定义为禁用首部名称的其他首部，允许人为设置的字段为 Fetch 规范定义的 对 CORS 安全的首部字段集合。该集合为：\n"),a("ul",[a("li",[t._v("Accept")]),t._v(" "),a("li",[t._v("Accept-Language")]),t._v(" "),a("li",[t._v("Content-Language")]),t._v(" "),a("li",[t._v("Content-Type （限于这三者：text/plain、multipart/form-data、application/x-www-form-urlencoded）")]),t._v(" "),a("li",[t._v("DPR")]),t._v(" "),a("li",[t._v("Downlink")]),t._v(" "),a("li",[t._v("Save-Data")]),t._v(" "),a("li",[t._v("Viewport-Width")]),t._v(" "),a("li",[t._v("Width")])])]),t._v(" "),a("li",[t._v("请求中的任意XMLHttpRequestUpload 对象均没有注册任何事件监听器；XMLHttpRequestUpload 对象可以使用 XMLHttpRequest.upload 属性访问。")]),t._v(" "),a("li",[t._v("请求中没有使用 ReadableStream 对象。")])]),t._v(" "),a("p",[t._v("从上面的条件可以看出，如果项目设置了 "),a("code",[t._v("content-type: application/json;charset=utf-8")]),t._v("，那相关的请求都不是简单请求了。")]),t._v(" "),a("blockquote",[a("p",[t._v("简单请求不会触发CORS预检请求。")])]),t._v(" "),a("h3",{attrs:{id:"非简单请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#非简单请求"}},[t._v("#")]),t._v(" 非简单请求")]),t._v(" "),a("p",[t._v('与简单请求相反的就是非简单请求，也就是"'),a("strong",[t._v("需预检的请求")]),t._v('"。它要求必须首先使用'),a("code",[t._v("OPTIONS")]),t._v('方法发起一个预检请求到服务器，让服务器知道是否允许该实际请求。"预检请求“的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响。')]),t._v(" "),a("blockquote",[a("p",[t._v("也就是说除了简单请求外，设置了自定义header、不在范围内的content-type 等这些，都是预检请求，都会先发送一个"),a("code",[t._v("option")]),t._v("请求给服务器，服务器再进行判断是否允许，如果不允许，则抛出错误。")])]),t._v(" "),a("a",{attrs:{"data-fancybox":"",href:t.$withBase("/browser/cors-preflight.png")}},[a("img",{attrs:{src:t.$withBase("/browser/cors-preflight.png")}})]),t._v(" "),a("h2",{attrs:{id:"http首部字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http首部字段"}},[t._v("#")]),t._v(" HTTP首部字段")]),t._v(" "),a("p",[t._v("从非简单请求的流程图可以看出，HTTP请求与HTTP响应的首部字段部分是对应的，通过请求和响应实现了控制。")]),t._v(" "),a("h3",{attrs:{id:"请求首部字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#请求首部字段"}},[t._v("#")]),t._v(" 请求首部字段")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("首部字段")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("预检请求")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("实际请求")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Origin: http://foo.example")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("预检请求或实际请求的源站(服务器名称)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Request-Method: POST")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("将实际请求所使用的 HTTP 方法告诉服务器")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("❌")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Request-Headers: X-My-Custom-Header")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("将实际请求所携带的首部字段告诉服务器")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("❌")])])])]),t._v(" "),a("h3",{attrs:{id:"响应首部字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#响应首部字段"}},[t._v("#")]),t._v(" 响应首部字段")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("首部字段")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("说明")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("预检请求")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("实际请求")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Allow-Origin: http://foo.example | *")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("允许访问该资源的外域 URI")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Expose-Headers: X-My-Custom-Header")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("让服务器把允许浏览器访问的头放入白名单")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Allow-Credentials: true")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("是否允许浏览器读取response的内容，false则不会返回数据")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Allow-Methods: POST,GET")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("实际请求所允许使用的 HTTP 方法")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Allow-Headers: X-My-Custom-Header, x-Token")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("实际请求中允许携带的首部字段")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[a("code",[t._v("Access-Control-Max-Age: 86400")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("preflight请求的结果能够被缓存多久(单位：秒)")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("✅")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("❌")])])])]),t._v(" "),a("h2",{attrs:{id:"cors流程图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cors流程图"}},[t._v("#")]),t._v(" CORS流程图")]),t._v(" "),a("p",[t._v("CORS的完整请求可以用以下流程图表示。")]),t._v(" "),a("ul",[a("li",[t._v("Invalid CORS 对应的状态码是："),a("code",[t._v("403")]),t._v("。")]),t._v(" "),a("li",[t._v("预检请求(OPTIONS)成功对应的状态码是："),a("code",[t._v("204")]),t._v("。(204: 请求成功，但body没有数据返回)")])]),t._v(" "),a("a",{attrs:{"data-fancybox":"",href:t.$withBase("/browser/cors-flow.png")}},[a("img",{attrs:{src:t.$withBase("/browser/cors-flow.png")}})])])}),[],!1,null,null,null);e.default=s.exports}}]);